version: "3.8"

services:
  # PostgreSQL Database
  postgres:
    image: postgres:15-alpine
    container_name: admin-service-db
    restart: unless-stopped
    environment:
      POSTGRES_USER: admin_user
      POSTGRES_PASSWORD: admin_password
      POSTGRES_DB: admin_service_db
    ports:
      - "5432:5432"
    volumes:
      - postgres_data:/var/lib/postgresql/data
      - ./init.sql:/docker-entrypoint-initdb.d/init.sql
    networks:
      - admin-network

  # Redis for token blacklisting
  redis:
    image: redis:7-alpine
    container_name: admin-service-redis
    restart: unless-stopped
    command: redis-server --appendonly yes
    ports:
      - "6379:6379"
    volumes:
      - redis_data:/data
    networks:
      - admin-network

  # Admin Service Backend
  admin-service:
    build: .
    container_name: admin-service-api
    restart: unless-stopped
    ports:
      - "8000:8000"
    environment:
      - NODE_ENV=production
      - PORT=8000
      - DATABASE_URL=postgresql://admin_user:admin_password@postgres:5432/admin_service_db
      - REDIS_URL=redis://redis:6379
      - JWT_SECRET=your-super-secret-jwt-key-change-this-in-production
      - ACCESS_TOKEN_EXPIRES_IN=15m
      - JWT_COOKIE_EXPIRES_IN=90
      - EMAIL_FROM=noreply@yourapp.com
      - EMAIL_USERNAME=your-email@gmail.com
      - EMAIL_PASSWORD=your-email-password
      - EMAIL_HOST=smtp.gmail.com
      - EMAIL_PORT=587
    depends_on:
      - postgres
      - redis
    networks:
      - admin-network
    volumes:
      - ./logs:/app/logs

  # Grafana (Optional - for testing OAuth2)
  grafana:
    image: grafana/grafana:latest
    container_name: admin-service-grafana
    restart: unless-stopped
    ports:
      - "3000:3000"
    environment:
      - GF_SECURITY_ADMIN_PASSWORD=admin
      - GF_AUTH_GENERIC_OAUTH_ENABLED=true
      - GF_AUTH_GENERIC_OAUTH_NAME=Admin Service
      - GF_AUTH_GENERIC_OAUTH_CLIENT_ID=grafana-client
      - GF_AUTH_GENERIC_OAUTH_CLIENT_SECRET=grafana-secret
      - GF_AUTH_GENERIC_OAUTH_SCOPES=read:user
      - GF_AUTH_GENERIC_OAUTH_AUTH_URL=http://localhost:8000/api/v1/oauth2/authorize
      - GF_AUTH_GENERIC_OAUTH_TOKEN_URL=http://admin-service:8000/api/v1/oauth2/token
      - GF_AUTH_GENERIC_OAUTH_API_URL=http://admin-service:8000/api/v1/oauth2/userinfo
      - GF_AUTH_GENERIC_OAUTH_ALLOW_SIGN_UP=true
    depends_on:
      - admin-service
    networks:
      - admin-network
    volumes:
      - grafana_data:/var/lib/grafana

volumes:
  postgres_data:
  redis_data:
  grafana_data:

networks:
  admin-network:
    driver: bridge
